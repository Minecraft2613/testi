<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Bank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .shadow-minecraft { box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.4); border: 3px solid #2c3e50; }
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a202c;
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }
        .diamond-loader {
            width: 64px; height: 64px;
            transform: rotate(45deg);
            animation: diamond-pulse 1.5s infinite cubic-bezier(0.455, 0.03, 0.515, 0.955);
        }
        .diamond-loader:before, .diamond-loader:after {
            content: ''; position: absolute;
            width: 100%; height: 100%;
            background-color: #34d399;
        }
        .diamond-loader:before {
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        @keyframes diamond-pulse {
            0% { transform: rotate(45deg) scale(1); opacity: 1; }
            50% { transform: rotate(45deg) scale(1.2); opacity: 0.8; }
            100% { transform: rotate(45deg) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const API_ENDPOINTS = {
            BASE: 'https://bank-data.1987sakshamsingh.workers.dev'
        };

        const Modal = ({ isOpen, title, message, onClose, type }) => {
            if (!isOpen) return null;
            const colors = { success: 'border-green-500', error: 'border-red-500', info: 'border-blue-500' };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                    <div className={`bg-gray-800 rounded-lg shadow-2xl p-6 max-w-sm w-full border-t-4 ${colors[type] || colors.info}`}>
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-end"><button onClick={onClose} className="px-5 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Close</button></div>
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="loading-screen">
                <div className="text-center">
                    <div className="diamond-loader"></div>
                    <p className="text-gray-300 mt-8 text-lg font-semibold animate-pulse">Loading Bank...</p>
                </div>
            </div>
        );

        const App = () => {
            const [page, setPage] = useState('loading');
            const [user, setUser] = useState(null);
            const [modal, setModal] = useState({ isOpen: false });

            const showModal = (title, message, type = 'info') => setModal({ isOpen: true, title, message, type });
            const closeModal = () => setModal({ isOpen: false });

            const handleLogin = async (identifier, password) => {
                setPage('loading');
                try {
                    const response = await fetch(`${API_ENDPOINTS.BASE}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ identifier, password })
                    });
                    const data = await response.json();
                    if (response.ok && data.account) {
                        setUser(data.account);
                        setPage('dashboard');
                    } else {
                        showModal('Login Failed', data.message || 'Invalid credentials.', 'error');
                        setPage('login');
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    showModal('Error', 'Could not connect to the server.', 'error');
                    setPage('login');
                }
            };
            
            const handleLogout = () => {
                setUser(null);
                setPage('login');
            };

            // Auto-refresh user data
            useEffect(() => {
                if (!user) return;
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_ENDPOINTS.BASE}/update-account`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accountId: user.accountId }) // Send identifier to get fresh data
                        });
                        if(response.ok) {
                            const data = await response.json();
                            setUser(data.account);
                        }
                    } catch (e) {
                        console.error("Failed to auto-refresh user data", e);
                    }
                }, 10000); // Refresh every 10 seconds
                return () => clearInterval(interval);
            }, [user]);


            useEffect(() => {
                // Simple startup logic
                setPage('login');
            }, []);

            const renderPage = () => {
                switch (page) {
                    case 'loading':
                        return <LoadingScreen />;
                    case 'login':
                        return <LoginPage handleLogin={handleLogin} setPage={setPage} />;
                    case 'create-account':
                        // Add CreateAccountPage component here if needed
                        return <div>Create Account Page</div>;
                    case 'dashboard':
                        return <Dashboard user={user} setUser={setUser} handleLogout={handleLogout} showModal={showModal} />;
                    default:
                        return <LoginPage handleLogin={handleLogin} setPage={setPage} />;
                }
            };

            return (
                <>
                    {renderPage()}
                    <Modal {...modal} onClose={closeModal} />
                </>
            );
        };
        
        const LoginPage = ({ handleLogin, setPage }) => {
             const [identifier, setIdentifier] = useState('');
             const [password, setPassword] = useState('');
             return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-800 p-4">
                    <div className="bg-gray-800 p-8 rounded-xl w-full max-w-md shadow-minecraft">
                        <h2 className="text-3xl font-bold text-green-400 mb-6 text-center">Minecraft Bank Login</h2>
                        <form onSubmit={(e) => { e.preventDefault(); handleLogin(identifier, password); }} className="space-y-4">
                            <input type="text" value={identifier} onChange={(e) => setIdentifier(e.target.value)} placeholder="Bank ID / MC Name / Email" required className="w-full p-3 bg-gray-700 text-gray-200 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" />
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password" required className="w-full p-3 bg-gray-700 text-gray-200 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" />
                            <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md">Login</button>
                        </form>
                    </div>
                </div>
             );
        };

        const Dashboard = ({ user, setUser, handleLogout, showModal }) => {
            // Main dashboard component
            return (
                <div>
                    <h1 className="text-2xl text-white">Welcome, {user.accountId}</h1>
                    <p className="text-white">Balance: ${user.balance.toFixed(2)}</p>
                    <button onClick={handleLogout} className="mt-4 bg-red-600 text-white p-2 rounded">Logout</button>
                    {/* All other dashboard components will go here */}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>